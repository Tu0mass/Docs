<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#0f212e">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Pro Crypto Casino</title>
<style>
    :root {
        --bg-app: #0f212e;
        --bg-panel: #1a2c38;
        --bg-input: #071018;
        --accent: #00e701;
        --accent-hover: #1fff20;
        --danger: #ff4949;
        --text-main: #ffffff;
        --text-sub: #b1bad3;
        --card-radius: 12px;
        --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; user-select: none; }
    
    body {
        background-color: var(--bg-app);
        color: var(--text-main);
        font-family: var(--font-stack);
        margin: 0;
        height: 100vh;
        height: 100dvh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* --- LAYOUT --- */
    header {
        height: 60px;
        background: var(--bg-panel);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        border-bottom: 1px solid #2f4553;
        flex-shrink: 0;
        z-index: 100;
    }

    .logo { font-weight: 900; font-style: italic; font-size: 20px; letter-spacing: -1px; }
    .logo span { color: var(--accent); }

    .wallet {
        background: var(--bg-input);
        padding: 8px 16px;
        border-radius: 20px;
        border: 1px solid #2f4553;
        font-weight: 700;
        font-size: 14px;
        color: var(--accent);
        display: flex;
        gap: 5px;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }

    /* Nav Scroll */
    .nav-scroller {
        background: var(--bg-panel);
        border-bottom: 1px solid #2f4553;
        padding: 0 10px;
        display: flex;
        gap: 5px;
        overflow-x: auto;
        flex-shrink: 0;
        scrollbar-width: none;
    }
    .nav-scroller::-webkit-scrollbar { display: none; }

    .nav-item {
        padding: 12px 16px;
        color: var(--text-sub);
        font-weight: 600;
        font-size: 13px;
        white-space: nowrap;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: 0.2s;
    }
    .nav-item.active { color: white; border-bottom-color: var(--accent); }

    /* Main Stage */
    .main-stage {
        flex: 1;
        display: flex;
        flex-direction: column; /* Mobile default */
        overflow: hidden;
        position: relative;
    }

    @media(min-width: 800px) {
        .main-stage { flex-direction: row-reverse; }
        .controls-area { width: 320px; border-right: 1px solid #2f4553; }
    }

    .game-view {
        flex: 1;
        background: radial-gradient(circle at center, #213743 0%, #0f212e 100%);
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
    }

    .controls-area {
        background: var(--bg-panel);
        padding: 20px;
        border-top: 1px solid #2f4553;
        display: flex;
        flex-direction: column;
        gap: 15px;
        z-index: 50;
        max-height: 40vh; /* Prevent covering game on small phones */
        overflow-y: auto;
    }

    /* --- UI COMPONENTS --- */
    .label { font-size: 11px; color: var(--text-sub); font-weight: 700; text-transform: uppercase; margin-bottom: 5px; display: block; }
    
    .input-group {
        display: flex;
        background: var(--bg-input);
        border: 1px solid #2f4553;
        border-radius: 6px;
        padding: 2px;
        transition: border 0.2s;
    }
    .input-group:focus-within { border-color: var(--accent); }
    
    .input-group input {
        background: transparent;
        border: none;
        color: white;
        flex: 1;
        padding: 10px;
        font-weight: 700;
        font-size: 15px;
        outline: none;
        min-width: 0;
    }

    .btn-mini {
        background: #213743;
        border: none;
        color: var(--text-sub);
        width: 40px;
        font-weight: 700;
        cursor: pointer;
        border-left: 1px solid #2f4553;
    }
    .btn-mini:active { background: #2f4553; color: white; }

    .btn-main {
        width: 100%;
        padding: 14px;
        background: var(--accent);
        color: #071018;
        border: none;
        border-radius: 6px;
        font-weight: 800;
        font-size: 16px;
        text-transform: uppercase;
        cursor: pointer;
        box-shadow: 0 4px 0 #00b300;
        transition: transform 0.1s;
    }
    .btn-main:active { transform: translateY(2px); box-shadow: 0 2px 0 #00b300; }
    .btn-main:disabled { filter: grayscale(1); cursor: not-allowed; }
    .btn-main.cashout { background: #ffffff; box-shadow: 0 4px 0 #ccc; }

    /* GAME CONTAINERS */
    .game-layer { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; }
    .game-layer.active { display: flex; }

    /* --- CRASH GRAPH --- */
    canvas { display: block; }
    .crash-overlay { position: absolute; font-size: 40px; font-weight: 800; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }

    /* --- BLACKJACK --- */
    .bj-table { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; max-width: 500px; }
    .bj-row { display: flex; justify-content: center; gap: 5px; height: 100px; }
    .bj-card { width: 60px; height: 84px; background: white; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; color: black; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.3); animation: deal 0.3s ease-out; }
    .bj-card.red { color: #d00000; }
    .bj-score { color: var(--text-sub); text-align: center; font-weight: 700; margin: 5px 0; }
    .bj-actions { display: flex; gap: 10px; justify-content: center; }
    .btn-bj { flex: 1; padding: 12px; border-radius: 6px; border: none; font-weight: 700; cursor: pointer; }
    .btn-hit { background: #2196f3; color: white; box-shadow: 0 4px 0 #0d47a1; }
    .btn-stand { background: #ff9800; color: white; box-shadow: 0 4px 0 #e65100; }
    @keyframes deal { from { transform: translateY(-50px) scale(0.5); opacity: 0; } to { transform: none; opacity: 1; } }

    /* --- ROULETTE TAPE --- */
    .roulette-wrapper { width: 100%; overflow: hidden; height: 100px; background: #071018; border-top: 2px solid #cca300; border-bottom: 2px solid #cca300; position: relative; display: flex; align-items: center; }
    .roulette-strip { display: flex; transition: transform 4s cubic-bezier(0.1, 0.8, 0.1, 1); }
    .r-tile { width: 60px; height: 60px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: 800; border-radius: 4px; margin: 0 2px; color: white; }
    .r-red { background: #ff4949; } .r-black { background: #2f4553; } .r-green { background: #00e701; color: black; }
    .r-marker { position: absolute; left: 50%; top: 0; bottom: 0; width: 4px; background: white; transform: translateX(-50%); z-index: 10; box-shadow: 0 0 10px white; }
    .roulette-bet-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 20px; width: 300px; }
    .r-btn { background: #213743; border: 1px solid #2f4553; color: var(--text-sub); padding: 10px; border-radius: 4px; font-weight: bold; cursor: pointer; }
    .r-btn.selected { border-color: var(--accent); color: white; background: #2f4553; }

    /* --- DICE --- */
    .dice-container { width: 90%; max-width: 400px; text-align: center; }
    .dice-result { font-size: 60px; font-weight: 900; color: white; margin: 20px 0; }
    .slider-track { width: 100%; height: 10px; background: #2f4553; border-radius: 5px; position: relative; margin: 20px 0; }
    .slider-fill { height: 100%; background: var(--accent); border-radius: 5px; width: 50%; transition: width 0.1s; }
    .dice-inputs { display: flex; justify-content: space-between; margin-bottom: 10px; }
    input[type=range] { width: 100%; opacity: 0; position: absolute; top: -10px; height: 30px; cursor: pointer; }

    /* --- COINFLIP --- */
    .coin-stage { perspective: 1000px; width: 150px; height: 150px; margin: 20px auto; }
    .coin { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 3s ease-out; }
    .coin-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 60px; border: 8px solid #cca300; background: #f1c40f; box-shadow: 0 0 20px rgba(255,215,0,0.3); }
    .coin-back { transform: rotateY(180deg); background: #e67e22; border-color: #d35400; }
    .cf-options { display: flex; gap: 10px; width: 200px; margin-top: 20px; }
    .cf-opt { flex: 1; padding: 10px; background: #213743; border-radius: 6px; text-align: center; border: 2px solid transparent; cursor: pointer; font-weight: bold; }
    .cf-opt.active { border-color: var(--accent); background: #2f4553; }

    /* --- SLOTS --- */
    .slot-machine { display: flex; gap: 10px; background: #071018; padding: 10px; border-radius: 8px; border: 2px solid #2f4553; }
    .reel { width: 60px; height: 100px; background: #1a2c38; border-radius: 4px; overflow: hidden; position: relative; text-align: center; font-size: 40px; line-height: 100px; }
    .reel-strip { display: flex; flex-direction: column; transition: transform 0.1s; }

    /* --- UTILS --- */
    .hidden { display: none !important; }
    #win-flash { position: absolute; inset: 0; background: white; opacity: 0; pointer-events: none; transition: opacity 0.5s; z-index: 999; }

</style>
</head>
<body>

<header>
    <div class="logo">STAKE<span>CLONE</span></div>
    <div class="wallet">
        $ <span id="balance-display">1,000.00</span>
    </div>
</header>

<div class="nav-scroller">
    <div class="nav-item active" onclick="setGame('crash')">Crash</div>
    <div class="nav-item" onclick="setGame('plinko')">Plinko</div>
    <div class="nav-item" onclick="setGame('mines')">Mines</div>
    <div class="nav-item" onclick="setGame('blackjack')">Blackjack</div>
    <div class="nav-item" onclick="setGame('roulette')">Roulette</div>
    <div class="nav-item" onclick="setGame('dice')">Dice</div>
    <div class="nav-item" onclick="setGame('coinflip')">Coinflip</div>
    <div class="nav-item" onclick="setGame('slots')">Slots</div>
</div>

<div class="main-stage">
    
    <!-- WIN FLASH EFFECT -->
    <div id="win-flash"></div>

    <!-- CONTROLS (Shared) -->
    <div class="controls-area">
        <div>
            <span class="label">Bet Amount</span>
            <div class="input-group">
                <input type="number" id="bet-input" value="10.00">
                <button class="btn-mini" onclick="adjBet(0.5)">¬Ω</button>
                <button class="btn-mini" onclick="adjBet(2)">2x</button>
            </div>
        </div>

        <!-- Game Specific Controls inserted via JS toggling -->
        <div id="ctrl-crash" class="game-ctrl">
            <button class="btn-main" id="btn-crash" onclick="playCrash()">Bet</button>
        </div>

        <div id="ctrl-plinko" class="game-ctrl hidden">
            <span class="label">Risk</span>
            <select id="plinko-risk" style="width:100%; padding:10px; background:#071018; color:white; border:1px solid #2f4553; border-radius:4px; margin-bottom:10px;">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
            </select>
            <button class="btn-main" onclick="playPlinko()">Drop Ball</button>
        </div>

        <div id="ctrl-mines" class="game-ctrl hidden">
            <span class="label">Mines (1-24)</span>
            <input type="range" min="1" max="24" value="3" oninput="updateMinesLabel(this.value)" style="width:100%">
            <div style="text-align:center; margin-bottom:10px;" id="mines-label">3 Mines</div>
            <button class="btn-main" id="btn-mines" onclick="startMines()">Bet</button>
            <button class="btn-main cashout hidden" id="btn-mines-cashout" onclick="cashoutMines()">Cashout</button>
        </div>

        <div id="ctrl-blackjack" class="game-ctrl hidden">
            <div style="text-align:center; color:#888; font-size:12px;">Dealer stands on 17</div>
            <button class="btn-main" id="btn-bj-deal" onclick="startBJ()">Deal</button>
        </div>

        <div id="ctrl-roulette" class="game-ctrl hidden">
            <div class="roulette-bet-grid">
                <div class="r-btn r-red" onclick="setRouletteBet('red')">Red (2x)</div>
                <div class="r-btn r-green" onclick="setRouletteBet('green')">Green (14x)</div>
                <div class="r-btn r-black" onclick="setRouletteBet('black')">Black (2x)</div>
            </div>
            <div id="roulette-select-display" style="text-align:center; margin:10px; color:var(--accent);">Bet: Red</div>
            <button class="btn-main" onclick="spinRoulette()">Spin</button>
        </div>

        <div id="ctrl-dice" class="game-ctrl hidden">
            <button class="btn-main" onclick="rollDice()">Roll</button>
        </div>

        <div id="ctrl-coinflip" class="game-ctrl hidden">
            <div class="cf-options">
                <div class="cf-opt active" id="cf-head" onclick="setCF(0)">Heads</div>
                <div class="cf-opt" id="cf-tail" onclick="setCF(1)">Tails</div>
            </div>
            <br>
            <button class="btn-main" onclick="flipCoin()">Flip</button>
        </div>

        <div id="ctrl-slots" class="game-ctrl hidden">
            <button class="btn-main" onclick="spinSlots()">Spin</button>
        </div>

    </div>

    <!-- GAMES VIEW -->
    <div class="game-view">
        
        <!-- CRASH -->
        <div id="game-crash" class="game-layer active">
            <canvas id="crash-canvas" style="width:100%; height:100%;"></canvas>
            <div class="crash-overlay" id="crash-text">1.00x</div>
        </div>

        <!-- PLINKO -->
        <div id="game-plinko" class="game-layer">
            <canvas id="plinko-canvas" width="400" height="400" style="max-width:100%; max-height:100%;"></canvas>
        </div>

        <!-- MINES -->
        <div id="game-mines" class="game-layer">
            <div id="mines-grid" style="display:grid; grid-template-columns:repeat(5,1fr); gap:5px; width:300px;"></div>
        </div>

        <!-- BLACKJACK -->
        <div id="game-blackjack" class="game-layer">
            <div class="bj-table">
                <div>
                    <div class="bj-score" id="dlr-score">Dealer</div>
                    <div class="bj-row" id="dlr-cards"></div>
                </div>
                <div style="text-align:center; color:rgba(255,255,255,0.2); font-weight:900; font-size:24px;">BLACKJACK</div>
                <div>
                    <div class="bj-row" id="plr-cards"></div>
                    <div class="bj-score" id="plr-score">Player</div>
                    <div class="bj-actions hidden" id="bj-actions">
                        <button class="btn-bj btn-hit" onclick="hitBJ()">HIT</button>
                        <button class="btn-bj btn-stand" onclick="standBJ()">STAND</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROULETTE -->
        <div id="game-roulette" class="game-layer">
            <div class="roulette-wrapper">
                <div class="r-marker"></div>
                <div class="roulette-strip" id="r-strip">
                    <!-- Generated via JS -->
                </div>
            </div>
        </div>

        <!-- DICE -->
        <div id="game-dice" class="game-layer">
            <div class="dice-container">
                <div class="dice-result" id="dice-result">50.00</div>
                <div class="dice-inputs">
                    <span class="label">Multiplier: <span id="dice-mult">2.00x</span></span>
                    <span class="label">Win Chance: <span id="dice-chance">49.5%</span></span>
                </div>
                <div class="slider-track">
                    <div class="slider-fill" id="dice-fill"></div>
                    <input type="range" min="2" max="98" value="50" id="dice-slider" oninput="updateDiceUI()">
                </div>
                <div class="label">Roll Over <span id="dice-target">50</span></div>
            </div>
        </div>

        <!-- COINFLIP -->
        <div id="game-coinflip" class="game-layer">
            <div class="coin-stage">
                <div class="coin" id="coin-el">
                    <div class="coin-face">ü¶Å</div> <!-- Heads -->
                    <div class="coin-face coin-back">üå¥</div> <!-- Tails -->
                </div>
            </div>
        </div>

        <!-- SLOTS -->
        <div id="game-slots" class="game-layer">
            <div class="slot-machine">
                <div class="reel"><div class="reel-strip" id="reel-1">üçí<br>üçã<br>üçá<br>üíé<br>7Ô∏è‚É£</div></div>
                <div class="reel"><div class="reel-strip" id="reel-2">üçí<br>üçã<br>üçá<br>üíé<br>7Ô∏è‚É£</div></div>
                <div class="reel"><div class="reel-strip" id="reel-3">üçí<br>üçã<br>üçá<br>üíé<br>7Ô∏è‚É£</div></div>
            </div>
            <div style="margin-top:20px; color:#fff; font-weight:bold;" id="slot-msg"></div>
        </div>

    </div>
</div>

<script>
/* ================= CORE SYSTEM ================= */
let balance = 1000.00;
let currentGame = 'crash';
const domBal = document.getElementById('balance-display');
const domBet = document.getElementById('bet-input');

function updateBal(amount) {
    balance += amount;
    domBal.innerText = balance.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
}

function adjBet(m) { 
    let v = parseFloat(domBet.value) * m; 
    if(v<0.01) v=0.01; 
    domBet.value = v.toFixed(2); 
}

function getBet() {
    const val = parseFloat(domBet.value);
    if(val > balance) { alert("Insufficient funds"); return 0; }
    return val;
}

function flashWin() {
    const f = document.getElementById('win-flash');
    f.style.opacity = 0.3;
    setTimeout(() => f.style.opacity = 0, 200);
    if(navigator.vibrate) navigator.vibrate(50);
}

function setGame(name) {
    currentGame = name;
    // Nav UI
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    event.target.classList.add('active');
    
    // View UI
    document.querySelectorAll('.game-layer').forEach(el => el.classList.remove('active'));
    document.getElementById('game-'+name).classList.add('active');
    
    // Control UI
    document.querySelectorAll('.game-ctrl').forEach(el => el.classList.add('hidden'));
    const ctrl = document.getElementById('ctrl-'+name);
    if(ctrl) ctrl.classList.remove('hidden');

    // Init specific games
    if(name === 'roulette' && !rStripBuilt) buildRoulette();
    if(name === 'mines') initMinesGrid();
    if(name === 'plinko') resizePlinko();
}


/* ================= GAME: CRASH ================= */
const cCanvas = document.getElementById('crash-canvas');
const cCtx = cCanvas.getContext('2d');
let cRunning = false, cMult = 1.0, cCrashPoint = 1.0, cBet = 0;

function resizeCrash() {
    cCanvas.width = cCanvas.parentElement.clientWidth;
    cCanvas.height = cCanvas.parentElement.clientHeight;
}
window.addEventListener('resize', resizeCrash);
resizeCrash();

function playCrash() {
    if(cRunning) { // Cashout
        const win = cBet * cMult;
        updateBal(win);
        cRunning = false;
        document.getElementById('btn-crash').innerText = "Bet";
        document.getElementById('btn-crash').classList.remove('cashout');
        document.getElementById('crash-text').style.color = "#00e701";
        document.getElementById('crash-text').innerText = "WON " + cMult.toFixed(2) + "x";
        flashWin();
        return;
    }

    // Start
    cBet = getBet();
    if(cBet === 0) return;
    updateBal(-cBet);
    
    cRunning = true;
    cMult = 1.00;
    // Weighted random crash point
    if(Math.random() < 0.3) cCrashPoint = 1.00 + (Math.random() * 0.5); // 30% chance instant crash
    else cCrashPoint = 1.00 + Math.pow(Math.random() * 10, 2);
    
    document.getElementById('btn-crash').innerText = "Cashout";
    document.getElementById('btn-crash').classList.add('cashout');
    document.getElementById('crash-text').style.color = "white";
    
    requestAnimationFrame(loopCrash);
}

function loopCrash() {
    if(!cRunning && cMult >= cCrashPoint) return; // Already cashed out or crashed
    if(!cRunning) return; 

    cMult += cMult * 0.015; // Speed
    document.getElementById('crash-text').innerText = cMult.toFixed(2) + "x";

    // Draw Graph
    cCtx.fillStyle = "#213743";
    cCtx.fillRect(0,0,cCanvas.width, cCanvas.height);
    
    cCtx.beginPath();
    cCtx.moveTo(0, cCanvas.height);
    // Simple Bezier curve simulation
    const progress = Math.min(1, (cMult - 1) / 5); // Scale graph
    const x = progress * cCanvas.width * 0.8;
    const y = cCanvas.height - (progress * cCanvas.height * 0.8);
    
    cCtx.quadraticCurveTo(x/2, cCanvas.height, x, y);
    cCtx.strokeStyle = "#00e701";
    cCtx.lineWidth = 4;
    cCtx.stroke();

    if(cMult >= cCrashPoint) {
        // BUST
        cRunning = false;
        document.getElementById('btn-crash').innerText = "Bet";
        document.getElementById('btn-crash').classList.remove('cashout');
        document.getElementById('crash-text').style.color = "#ff4949";
        document.getElementById('crash-text').innerText = "CRASHED @ " + cCrashPoint.toFixed(2) + "x";
    } else {
        requestAnimationFrame(loopCrash);
    }
}


/* ================= GAME: BLACKJACK ================= */
const suits = ['‚ô†','‚ô•','‚ô¶','‚ô£'];
const values = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
let deck = [], plrHand = [], dlrHand = [], bjBet = 0, bjActive = false;

function createDeck() {
    deck = [];
    for(let s of suits) for(let v of values) deck.push({s, v, w: getCardWeight(v)});
    deck.sort(() => Math.random() - 0.5);
}

function getCardWeight(v) {
    if(['J','Q','K'].includes(v)) return 10;
    if(v === 'A') return 11;
    return parseInt(v);
}

function renderCard(card, elId) {
    const div = document.createElement('div');
    div.className = 'bj-card ' + (['‚ô•','‚ô¶'].includes(card.s) ? 'red' : '');
    div.innerText = card.v + card.s;
    document.getElementById(elId).appendChild(div);
}

function getHandValue(hand) {
    let sum = 0, aces = 0;
    for(let c of hand) { sum += c.w; if(c.v === 'A') aces++; }
    while(sum > 21 && aces > 0) { sum -= 10; aces--; }
    return sum;
}

function startBJ() {
    bjBet = getBet();
    if(bjBet === 0) return;
    updateBal(-bjBet);
    
    createDeck();
    plrHand = [deck.pop(), deck.pop()];
    dlrHand = [deck.pop(), deck.pop()];
    bjActive = true;
    
    // UI
    document.getElementById('plr-cards').innerHTML = '';
    document.getElementById('dlr-cards').innerHTML = '';
    document.getElementById('btn-bj-deal').classList.add('hidden');
    document.getElementById('bj-actions').classList.remove('hidden');
    
    renderCard(plrHand[0], 'plr-cards');
    renderCard(plrHand[1], 'plr-cards');
    renderCard(dlrHand[0], 'dlr-cards');
    
    // Hidden dealer card
    const hidden = document.createElement('div');
    hidden.className = 'bj-card';
    hidden.style.background = '#2f4553';
    hidden.id = 'dlr-hidden';
    document.getElementById('dlr-cards').appendChild(hidden);
    
    updateScores();
    
    // Check Instant Blackjack
    if(getHandValue(plrHand) === 21) standBJ();
}

function hitBJ() {
    const c = deck.pop();
    plrHand.push(c);
    renderCard(c, 'plr-cards');
    updateScores();
    if(getHandValue(plrHand) > 21) endBJ(false); // Bust
}

async function standBJ() {
    document.getElementById('dlr-hidden').remove();
    renderCard(dlrHand[1], 'dlr-cards');
    
    while(getHandValue(dlrHand) < 17) {
        await new Promise(r => setTimeout(r, 800));
        const c = deck.pop();
        dlrHand.push(c);
        renderCard(c, 'dlr-cards');
        updateScores();
    }
    
    const p = getHandValue(plrHand);
    const d = getHandValue(dlrHand);
    
    if(d > 21 || p > d) endBJ(true);
    else if(p === d) endBJ('push');
    else endBJ(false);
}

function updateScores() {
    document.getElementById('plr-score').innerText = getHandValue(plrHand);
    if(!bjActive) document.getElementById('dlr-score').innerText = getHandValue(dlrHand);
}

function endBJ(res) {
    bjActive = false;
    document.getElementById('bj-actions').classList.add('hidden');
    document.getElementById('btn-bj-deal').classList.remove('hidden');
    updateScores();
    
    if(res === true) {
        updateBal(bjBet * 2);
        flashWin();
    } else if(res === 'push') {
        updateBal(bjBet); // refund
    }
}

/* ================= GAME: ROULETTE ================= */
const rNums = [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26];
let rStripBuilt = false, rBetType = 'red', rBetAmt = 0;

function buildRoulette() {
    const strip = document.getElementById('r-strip');
    // Build long strip for scrolling illusion
    for(let i=0; i<5; i++) { // Repeat pattern
        rNums.forEach(n => {
            const el = document.createElement('div');
            el.className = 'r-tile';
            el.innerText = n;
            if(n === 0) el.classList.add('r-green');
            else if([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36].includes(n)) el.classList.add('r-red');
            else el.classList.add('r-black');
            strip.appendChild(el);
        });
    }
    rStripBuilt = true;
}

function setRouletteBet(type) {
    rBetType = type;
    document.querySelectorAll('.r-btn').forEach(b => b.classList.remove('selected'));
    event.target.classList.add('selected');
    document.getElementById('roulette-select-display').innerText = "Bet: " + type.toUpperCase();
}

function spinRoulette() {
    rBetAmt = getBet();
    if(rBetAmt === 0) return;
    updateBal(-rBetAmt);
    
    // Determine result
    const rIndex = Math.floor(Math.random() * 37); 
    // Visual index (land in the middle of the strip)
    const landIndex = (rNums.length * 2) + rIndex; 
    const tileSize = 64; // 60px width + 4px margin
    
    // Jitter to not land perfectly in center
    const offset = (Math.random() * 40) - 20; 
    
    const strip = document.getElementById('r-strip');
    const scrollPos = (landIndex * tileSize) + offset - (document.querySelector('.roulette-wrapper').clientWidth/2) + 30;
    
    strip.style.transition = "transform 3s cubic-bezier(0.1, 1, 0.3, 1)";
    strip.style.transform = `translateX(-${scrollPos}px)`;
    
    setTimeout(() => {
        strip.style.transition = "none";
        // Logic
        const winNum = rNums[rIndex];
        let won = false;
        let payout = 0;
        
        const isRed = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36].includes(winNum);
        
        if(rBetType === 'green' && winNum === 0) { won = true; payout = 14; }
        else if(rBetType === 'red' && isRed) { won = true; payout = 2; }
        else if(rBetType === 'black' && winNum !== 0 && !isRed) { won = true; payout = 2; }
        
        if(won) {
            updateBal(rBetAmt * payout);
            flashWin();
        }
        
        // Reset visual for next spin after delay?
        // For simple infinite scroll illusion, we'd jump back to index 0, but let's just leave it.
    }, 3000);
}

/* ================= GAME: DICE ================= */
function updateDiceUI() {
    const val = parseInt(document.getElementById('dice-slider').value);
    document.getElementById('dice-target').innerText = val;
    document.getElementById('dice-fill').style.width = val + "%";
    
    const chance = 100 - val;
    const mult = (99 / chance).toFixed(2);
    
    document.getElementById('dice-chance').innerText = chance + "%";
    document.getElementById('dice-mult').innerText = mult + "x";
}
updateDiceUI(); // Init

function rollDice() {
    const bet = getBet();
    if(bet === 0) return;
    updateBal(-bet);
    
    // Animation
    const resEl = document.getElementById('dice-result');
    let rolls = 0;
    const interval = setInterval(() => {
        resEl.innerText = (Math.random() * 100).toFixed(2);
        rolls++;
        if(rolls > 10) {
            clearInterval(interval);
            const final = Math.random() * 100;
            resEl.innerText = final.toFixed(2);
            
            const target = parseInt(document.getElementById('dice-slider').value);
            if(final > target) {
                const chance = 100 - target;
                const mult = 99 / chance;
                updateBal(bet * mult);
                resEl.style.color = "#00e701";
                flashWin();
            } else {
                resEl.style.color = "#ff4949";
            }
        }
    }, 50);
}

/* ================= GAME: COINFLIP ================= */
let cfChoice = 0; // 0 head, 1 tail
function setCF(c) {
    cfChoice = c;
    document.getElementById('cf-head').classList.toggle('active', c===0);
    document.getElementById('cf-tail').classList.toggle('active', c===1);
}
function flipCoin() {
    const bet = getBet();
    if(bet === 0) return;
    updateBal(-bet);
    
    const isHeads = Math.random() > 0.5;
    const coin = document.getElementById('coin-el');
    
    // Reset anim
    coin.style.transition = "none";
    coin.style.transform = "rotateY(0deg)";
    
    setTimeout(() => {
        coin.style.transition = "transform 3s ease-out";
        const rot = 1800 + (isHeads ? 0 : 180);
        coin.style.transform = `rotateY(${rot}deg)`;
        
        setTimeout(() => {
            const win = (cfChoice === 0 && isHeads) || (cfChoice === 1 && !isHeads);
            if(win) {
                updateBal(bet * 1.98);
                flashWin();
            }
        }, 3000);
    }, 50);
}

/* ================= GAME: SLOTS ================= */
const symbols = ['üçí','üçã','üçá','üíé','7Ô∏è‚É£'];
function spinSlots() {
    const bet = getBet();
    if(bet === 0) return;
    updateBal(-bet);
    document.getElementById('slot-msg').innerText = "";
    
    for(let i=1; i<=3; i++) {
        const strip = document.getElementById('reel-'+i);
        // Reset pos
        strip.style.transition = 'none';
        strip.style.transform = `translateY(0px)`;
        
        setTimeout(() => {
            const stopIdx = Math.floor(Math.random() * symbols.length);
            // Visual spin
            strip.style.transition = `transform ${1 + (i*0.5)}s cubic-bezier(0.5, 0, 0.2, 1)`;
            // We simulate spin by moving specific pixels. 
            // Reel height 100px. Text centered.
            // Let's just replace content for simplicity in this logic
            strip.innerHTML = generateReelHTML(stopIdx);
        }, 50);
    }
    
    setTimeout(() => {
        // Logic Check (simplified, visual is messy without Canvas but functional)
        const r1 = document.getElementById('reel-1').innerText.split('\n')[2]; // middle symbol
        const r2 = document.getElementById('reel-2').innerText.split('\n')[2];
        const r3 = document.getElementById('reel-3').innerText.split('\n')[2];
        
        if(r1 === r2 && r2 === r3) {
            let mult = 10;
            if(r1 === 'üíé') mult = 50;
            if(r1 === '7Ô∏è‚É£') mult = 100;
            updateBal(bet * mult);
            document.getElementById('slot-msg').innerText = "JACKPOT! " + mult + "x";
            flashWin();
        } else if(r1 === r2 || r2 === r3 || r1 === r3) {
            updateBal(bet * 1.5);
            document.getElementById('slot-msg').innerText = "Small Win";
        }
    }, 2600);
}

function generateReelHTML(targetIdx) {
    // Create a stack where the target is in the middle
    // Stack: [Rand, Rand, TARGET, Rand, Rand]
    let html = "";
    for(let i=0; i<5; i++) {
        if(i===2) html += symbols[targetIdx] + "<br>";
        else html += symbols[Math.floor(Math.random()*symbols.length)] + "<br>";
    }
    return html;
}

/* ================= GAME: MINES & PLINKO (Simplified Ports) ================= */
// Mines
let minesActive = false, mGrid = [], mRevealed = 0, mCount = 3, mBet = 0;
function updateMinesLabel(v) { mCount = parseInt(v); document.getElementById('mines-label').innerText = v + " Mines"; }
function initMinesGrid() {
    const g = document.getElementById('mines-grid'); g.innerHTML='';
    for(let i=0; i<25; i++) {
        const b = document.createElement('button');
        b.className = 'btn-mini';
        b.style.width='100%'; b.style.height='50px'; b.style.fontSize='20px'; b.style.background='#213743';
        b.onclick = ()=>clickMine(i, b);
        g.appendChild(b);
    }
}
function startMines() {
    mBet = getBet(); if(!mBet) return; updateBal(-mBet);
    mGrid = Array(25).fill(0); let p=0;
    while(p<mCount) { let r=Math.floor(Math.random()*25); if(!mGrid[r]){mGrid[r]=1; p++;} }
    minesActive=true; mRevealed=0;
    initMinesGrid();
    document.getElementById('btn-mines').classList.add('hidden');
    document.getElementById('btn-mines-cashout').classList.remove('hidden');
}
function clickMine(i, el) {
    if(!minesActive || el.classList.contains('rev')) return;
    el.classList.add('rev');
    if(mGrid[i]) { // Bomb
        el.innerText = 'üí£'; el.style.background='#ff4949'; minesActive=false;
        document.getElementById('btn-mines').classList.remove('hidden');
        document.getElementById('btn-mines-cashout').classList.add('hidden');
    } else { // Gem
        el.innerText = 'üíé'; el.style.background='#071018'; mRevealed++;
        if(mRevealed === 25-mCount) cashoutMines();
    }
}
function cashoutMines() {
    if(!minesActive) return;
    minesActive=false;
    // Fake Multiplier Logic
    let mult = 1; 
    for(let k=0; k<mRevealed; k++) mult *= (25-k)/(25-mCount-k);
    updateBal(mBet * mult * 0.99);
    flashWin();
    document.getElementById('btn-mines').classList.remove('hidden');
    document.getElementById('btn-mines-cashout').classList.add('hidden');
}

// Plinko (Simplified Visuals)
const pCanvas = document.getElementById('plinko-canvas'); const pCtx = pCanvas.getContext('2d');
let pBalls = [];
function resizePlinko() { pCanvas.width = pCanvas.clientWidth; pCanvas.height = pCanvas.clientHeight; }
function playPlinko() {
    const bet = getBet(); if(!bet) return; updateBal(-bet);
    pBalls.push({x: pCanvas.width/2, y: 20, vx: (Math.random()-0.5)*2, vy: 0, bet: bet});
    if(pBalls.length===1) loopPlinko();
}
function loopPlinko() {
    if(pBalls.length===0) return;
    pCtx.clearRect(0,0,pCanvas.width,pCanvas.height);
    
    // Draw Pegs (Static Visual)
    pCtx.fillStyle = 'white';
    for(let r=0; r<12; r++) {
        for(let c=0; c<=r+2; c++) {
            pCtx.beginPath();
            pCtx.arc((pCanvas.width/2) + (c-(r+2)/2)*25, 50 + r*25, 3, 0, 6.28);
            pCtx.fill();
        }
    }
    
    // Update Balls
    for(let i=pBalls.length-1; i>=0; i--) {
        let b = pBalls[i];
        b.vy += 0.2; b.y += b.vy; b.x += b.vx;
        // Random bounce logic simulation
        if(b.y % 25 < 5 && b.y > 50) b.vx += (Math.random()-0.5)*2;
        
        pCtx.beginPath(); pCtx.arc(b.x, b.y, 6, 0, 6.28);
        pCtx.fillStyle='#e67e22'; pCtx.fill();
        
        if(b.y > 350) {
            // Finished
            let mult = Math.random()*5; // Fake result
            if(Math.abs(b.x - pCanvas.width/2) > 100) mult = 10;
            updateBal(b.bet * (mult/2));
            pBalls.splice(i, 1);
        }
    }
    requestAnimationFrame(loopPlinko);
}

// Start Loop
setInterval(()=>{}, 1000); // Keep alive
setGame('crash');

</script>
</body>
</html>